<!DOCTYPE html>
<html>
<head>
    <title>EMDR App</title>
    <style>
        body {
            margin: 0;
            color: #CCCCCC;
            background-color: #1E1E1E;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        #scene-container {
            width: 100%;
            height: 100vh;
            display: block;
        }
        /* Control Panel Styles */
        .control-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 10px;
            background: rgba(30, 30, 30, 0.9);
            box-sizing: border-box;
            display: none;
            flex-wrap: wrap;
            justify-content: space-around;
            max-height: 50%;
            overflow-y: auto;
            font-size: 14px;
            color: #FFFFFF;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.7);
        }
        .control-group {
            margin: 5px;
            min-width: 120px;
            display: flex;
            flex-direction: column;
        }
        .control-group label {
            margin-bottom: 5px;
            font-size: 13px;
        }
        .control-group input[type="number"],
        .control-group select {
            width: 60px;
            padding: 5px;
            background-color: #2D2D2D;
            color: #FFFFFF;
            border: 1px solid #555;
            border-radius: 4px;
            font-size: 13px;
        }
        .control-group input[type="number"]:focus {
            outline: none;
        }
        .control-group input[type="number"] {
            text-align: right;
        }
        .control-group input[type="number"]::-webkit-inner-spin-button,
        .control-group input[type="number"]::-webkit-outer-spin-button {
            opacity: 1;
        }
        .control-group input[type="number"] {
            -moz-appearance: textfield;
        }
        .control-group input[type="number"]:hover {
            cursor: ns-resize;
        }
        .control-group input[type="number"]:disabled {
            opacity: 0.5;
        }
        .control-group input[type="color"] {
            width: 30px;
            height: 30px;
            border: none;
            padding: 0;
            background: none;
            cursor: pointer;
        }
        .control-group .checkbox-label {
            display: flex;
            align-items: center;
            font-size: 13px;
        }
        .control-group .checkbox-label input {
            margin-right: 5px;
        }
        #startButton, #endButton { 
            position: absolute; 
            bottom: 10px;
            right: 10px;
            padding: 10px 20px;
            font-size: 16px;
            background-color: #007ACC;
            color: #FFFFFF;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            opacity: 1;
            transition: opacity 0.5s;
            z-index: 999;
        }
        #startButton.hidden, #endButton.hidden {
            opacity: 0;
        }
        /* Icons */
        .icon-button {
            position: absolute;
            top: 10px;
            width: 40px;
            height: 40px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }
        #settingsButton {
            left: 10px;
        }
        #questionsButton {
            left: 60px;
        }
        /* Sound Type Container */
        .sound-type-container {
            position: absolute;
            top: 60px;
            left: 10px;
            background: rgba(30, 30, 30, 0.9);
            padding: 10px;
            border-radius: 5px;
            display: none;
            color: #FFFFFF;
            z-index: 999;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .sound-type-container label {
            display: block;
            color: white;
            font-size: 13px;
            margin-bottom: 5px;
        }
        /* Questions Panel */
        .questions-panel {
            position: absolute;
            top: 60px;
            left: 10%;
            right: 10%;
            bottom: 10px;
            background: rgba(30, 30, 30, 0.95);
            padding: 20px;
            overflow-y: auto;
            overflow-x: hidden;
            display: none;
            box-sizing: border-box;
            color: #FFFFFF;
            font-size: 14px;
            box-shadow: 0 0 20px rgba(0,0,0,0.7);
            border-radius: 8px;
            z-index: 999;
        }
        .questions-panel h2 {
            margin-top: 0;
            text-align: center;
            margin-bottom: 20px;
        }
        .question {
            margin-bottom: 20px;
        }
        .question label {
            display: block;
            margin-bottom: 5px;
        }
        .question textarea {
            width: 100%;
            resize: vertical;
            padding: 10px;
            background-color: #2D2D2D;
            color: #FFFFFF;
            border: 1px solid #555;
            border-radius: 4px;
            font-family: inherit;
            font-size: 14px;
        }
        .question input[type="range"] {
            width: 100%;
        }
        .question .range-value {
            text-align: right;
            font-size: 13px;
        }
        .sub-questions {
            padding-left: 20px;
        }
    </style>
    <script src="three.min.js"></script>
</head>
<body>
    <div id="scene-container"></div>
    <!-- Icons -->
    <button id="settingsButton" class="icon-button" title="Settings">
        &#9881;
    </button>
    <button id="questionsButton" class="icon-button" title="Therapeutic Guidance">
        &#127800;
    </button>
    <!-- Control Panel -->
    <div class="control-panel" id="controlPanel">
        <div class="control-group">
            <label for="speedControl">Speed:</label>
            <input type="number" id="speedControl" min="0.1" max="5" step="0.1" value="1.2" onkeydown="return false;">
        </div>
        <div class="control-group">
            <label for="ballSizeControl">Ball Size:</label>
            <input type="number" id="ballSizeControl" min="0.1" max="2" step="0.1" value="0.5" onkeydown="return false;">
        </div>
        <div class="control-group">
            <label for="frequencyControl">Frequency (Hz):</label>
            <input type="number" id="frequencyControl" min="20" max="2000" step="1" value="220" onkeydown="return false;">
        </div>
        <div class="control-group">
            <label for="volumeControl">Volume:</label>
            <input type="number" id="volumeControl" min="0" max="1" step="0.01" value="0.3" onkeydown="return false;">
        </div>
        <div class="control-group">
            <label for="ballColorControl">Ball Color:</label>
            <input type="color" id="ballColorControl" value="#ff0000">
        </div>
        <div class="control-group">
            <label for="bgColorControl">Background Color:</label>
            <input type="color" id="bgColorControl" value="#000000">
        </div>
        <div class="control-group">
            <label for="fontColorControl">Font Color:</label>
            <input type="color" id="fontColorControl" value="#FFFFFF">
        </div>
        <div class="control-group">
            <label for="fontTypeControl">Font Type:</label>
            <select id="fontTypeControl">
                <option value="'Segoe UI', Tahoma, Geneva, Verdana, sans-serif" selected>Default</option>
                <option value="Arial, sans-serif">Arial</option>
                <option value="'Courier New', Courier, monospace">Courier New</option>
                <option value="Georgia, serif">Georgia</option>
                <option value="Tahoma, Geneva, sans-serif">Tahoma</option>
                <option value="'Times New Roman', Times, serif">Times New Roman</option>
                <option value="Verdana, Geneva, sans-serif">Verdana</option>
            </select>
        </div>
        <div class="control-group">
            <label class="checkbox-label"><input type="checkbox" id="invertPanning"> Invert Sound Panning</label>
        </div>
        <div class="control-group">
            <label for="textureControl">Ball Texture:</label>
            <select id="textureControl">
                <option value="solid" selected>Solid</option>
                <option value="wireframe">Wireframe</option>
            </select>
        </div>
        <div class="control-group">
            <label for="textSizeControl">Text Size (px):</label>
            <input type="number" id="textSizeControl" min="12" max="24" step="1" value="16" onkeydown="return false;">
        </div>
    </div>
    <!-- Sound Type Container -->
    <div class="sound-type-container" id="soundTypeContainer">
        <label><input type="radio" name="soundType" value="sine" checked>Sine</label>
        <label><input type="radio" name="soundType" value="square">Square</label>
        <label><input type="radio" name="soundType" value="sawtooth">Sawtooth</label>
        <label><input type="radio" name="soundType" value="triangle">Triangle</label>
    </div>
    <!-- Questions Panel -->
    <div class="questions-panel" id="questionsPanel">
        <h2>Therapeutic Guidance</h2>
        <div class="question" style="font-style: italic; font-size: 13px; margin-bottom: 30px;">
            Note: If you do not feel any emotions when describing your Target issue, it might indicate a form of psychological dissociation. In that case, it's adviced to seek professional guidance to help you become unstuck.
        </div>
        <div class="question">
            <label for="question1">1. How are you feeling today?</label>
            <textarea id="question1" rows="3"></textarea>
        </div>
        <div class="question">
            <label for="question2">2. What are the issues prompting you to do a session today?</label>
            <textarea id="question2" rows="3"></textarea>
        </div>
        <div class="question">
            <label>3. Now let's add detail to your Target to make it as vivid and real as possible:</label>
            <div class="sub-questions">
                <div class="question">
                    <label for="question3a">- What images, sounds, or smells are triggered when you think of the Target?</label>
                    <textarea id="question3a" rows="3"></textarea>
                </div>
                <div class="question">
                    <label for="question3b">- What do you recall of the traumatic event that led you to do today's session?</label>
                    <textarea id="question3b" rows="3"></textarea>
                </div>
                <div class="question">
                    <label for="question3c">- What feelings or emotions come up when you think of the Target?</label>
                    <textarea id="question3c" rows="3"></textarea>
                </div>
                <div class="question">
                    <label for="question3d">- What is the most disturbing moment or aspect of the traumatic event?</label>
                    <textarea id="question3d" rows="3"></textarea>
                </div>
                <div class="question">
                    <label for="question3e">- What physical sensations do you experience when you think of the Target?</label>
                    <textarea id="question3e" rows="3"></textarea>
                </div>
            </div>
        </div>
        <div class="question">
            <label for="question4">4. Combine these answers into a single description of your Target that incorporates key elements of what you described:</label>
            <textarea id="question4" rows="3"></textarea>
        </div>
        <div class="question">
            <label for="question5">5. What are your negative beliefs?</label>
            <textarea id="question5" rows="3"></textarea>
        </div>
        <div class="question">
            <label for="question6">6. Write down some positive beliefs about yourself:</label>
            <textarea id="question6" rows="3"></textarea>
        </div>
        <div class="question">
            <label for="question7">7. What is your Emotional Distress Rating now when you think of the Target? (1-10)</label>
            <input type="range" id="question7" min="1" max="10" step="1" value="1">
            <div class="range-value">Rating: <span id="question7Value">1</span></div>
        </div>
        <div class="question">
            <label>8. Now, please take 10-40 minutes to focus on the target and do EMDR while thinking about the issue. After that session, return here.</label>
        </div>
        <div class="question">
            <label for="question9">9. After your EMDR session, what is your Emotional Distress Rating now? (1-10)</label>
            <input type="range" id="question9" min="1" max="10" step="1" value="1">
            <div class="range-value">Rating: <span id="question9Value">1</span></div>
        </div>
        <div class="question">
            <label>10. You can continue doing EMDR on this issue as needed until you feel sufficiently at ease.</label>
        </div>
    </div>
    <!-- Start/End Buttons -->
    <button id="startButton">Start</button>
    <button id="endButton" style="display:none;">End</button>
    <script>
        let scene, camera, renderer;
        let geometry, material, mesh;
        let heartRate = 1.2, frequency = 220, volume = 0.3;
        let oscillator, gainNode, audioContext, panner;
        let animationFrameId;
        let direction = 0.1;
        let isAudioStarted = false;
        let ballSize = 0.5;
        let invertPanning = false;
        let ballColor = "#ff0000";
        let bgColor = "#000000";
        let materialType = "solid";
        let fontColor = "#FFFFFF";
        let fontType = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
        let textSize = 16;

        function init() {
            const sceneContainer = document.getElementById('scene-container');
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            sceneContainer.appendChild(renderer.domElement);

            geometry = new THREE.SphereGeometry(1, 32, 32);
            material = new THREE.MeshBasicMaterial({ color: ballColor });
            mesh = new THREE.Mesh(geometry, material);
            mesh.scale.set(ballSize, ballSize, ballSize);
            scene.add(mesh);

            camera.position.z = 5;

            // Event listeners for controls
            document.getElementById('startButton').addEventListener('click', startAudio);
            document.getElementById('endButton').addEventListener('click', stopAudio);

            document.getElementById('speedControl').addEventListener('input', (e) => {
                heartRate = parseFloat(e.target.value);
            });
            document.getElementById('ballSizeControl').addEventListener('input', (e) => {
                ballSize = parseFloat(e.target.value);
                mesh.scale.set(ballSize, ballSize, ballSize);
            });
            document.getElementById('frequencyControl').addEventListener('input', (e) => {
                frequency = parseFloat(e.target.value);
                if (oscillator) oscillator.frequency.value = frequency;
            });
            document.getElementById('volumeControl').addEventListener('input', (e) => {
                volume = parseFloat(e.target.value);
                if (gainNode) gainNode.gain.value = volume;
            });
            document.getElementById('ballColorControl').addEventListener('input', (e) => {
                ballColor = e.target.value;
                material.color.set(ballColor);
            });
            document.getElementById('bgColorControl').addEventListener('input', (e) => {
                bgColor = e.target.value;
                document.body.style.backgroundColor = bgColor;
            });
            document.getElementById('fontColorControl').addEventListener('input', (e) => {
                fontColor = e.target.value;
                updateFontStyles();
            });
            document.getElementById('fontTypeControl').addEventListener('change', (e) => {
                fontType = e.target.value;
                updateFontStyles();
            });
            document.getElementById('invertPanning').addEventListener('change', (e) => {
                invertPanning = e.target.checked;
            });
            document.getElementById('textureControl').addEventListener('change', (e) => {
                materialType = e.target.value;
                updateMaterial();
            });
            document.getElementById('textSizeControl').addEventListener('input', (e) => {
                textSize = parseInt(e.target.value);
                updateFontStyles();
            });
            document.getElementById('settingsButton').addEventListener('click', toggleControls);
            document.getElementById('questionsButton').addEventListener('click', toggleQuestions);

            // Update rating display for question7 and question9
            document.getElementById('question7').addEventListener('input', (e) => {
                document.getElementById('question7Value').innerText = e.target.value;
            });
            document.getElementById('question9').addEventListener('input', (e) => {
                document.getElementById('question9Value').innerText = e.target.value;
            });

            window.addEventListener('resize', onWindowResize);

            // Event listeners for sound type radio buttons
            document.querySelectorAll('input[name="soundType"]').forEach((input) => {
                input.addEventListener('change', updateSoundType);
            });

            // Spacebar to stop animation
            document.addEventListener('keydown', (e) => {
                if (e.code === 'Space' && isAudioStarted) {
                    stopAudio();
                }
            });

            updateFontStyles();
        }

        function updateFontStyles() {
            const questionsPanel = document.getElementById('questionsPanel');
            questionsPanel.style.color = fontColor;
            questionsPanel.style.fontFamily = fontType;
            questionsPanel.style.fontSize = textSize + 'px';

            const controlPanel = document.getElementById('controlPanel');
            controlPanel.style.color = fontColor;
            controlPanel.style.fontFamily = fontType;
            controlPanel.style.fontSize = textSize + 'px';
        }

        function toggleControls() {
            const controlPanel = document.getElementById('controlPanel');
            const soundTypeContainer = document.getElementById('soundTypeContainer');
            const questionsPanel = document.getElementById('questionsPanel');

            if (controlPanel.style.display === 'none') {
                controlPanel.style.display = 'flex';
                soundTypeContainer.style.display = 'block';
                questionsPanel.style.display = 'none';
            } else {
                controlPanel.style.display = 'none';
                soundTypeContainer.style.display = 'none';
            }
        }

        function toggleQuestions() {
            const questionsPanel = document.getElementById('questionsPanel');
            const controlPanel = document.getElementById('controlPanel');
            const soundTypeContainer = document.getElementById('soundTypeContainer');

            if (questionsPanel.style.display === 'none') {
                questionsPanel.style.display = 'block';
                controlPanel.style.display = 'none';
                soundTypeContainer.style.display = 'none';
            } else {
                questionsPanel.style.display = 'none';
            }
        }

        function updateMaterial() {
            scene.remove(mesh);
            if (materialType === "wireframe") {
                material = new THREE.MeshBasicMaterial({ color: ballColor, wireframe: true });
            } else {
                material = new THREE.MeshBasicMaterial({ color: ballColor });
            }
            mesh = new THREE.Mesh(geometry, material);
            mesh.scale.set(ballSize, ballSize, ballSize);
            scene.add(mesh);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function startAudio() {
            document.getElementById('startButton').style.display = "none";
            document.getElementById('endButton').style.display = 'block';

            // Close questions and controls when starting EMDR
            document.getElementById('questionsPanel').style.display = 'none';
            document.getElementById('controlPanel').style.display = 'none';
            document.getElementById('soundTypeContainer').style.display = 'none';

            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            oscillator = audioContext.createOscillator();
            gainNode = audioContext.createGain();
            panner = audioContext.createStereoPanner();

            oscillator.connect(gainNode);
            gainNode.connect(panner);
            panner.connect(audioContext.destination);

            const soundType = document.querySelector('input[name="soundType"]:checked').value;
            oscillator.type = soundType;
            oscillator.frequency.value = frequency;
            gainNode.gain.value = volume;

            oscillator.start();
            isAudioStarted = true;

            // Fade out start button
            document.getElementById('startButton').classList.add('hidden');

            animate();
        }

        function animate() {
            if (!isAudioStarted) return;
            animationFrameId = requestAnimationFrame(animate);

            mesh.position.x += direction * heartRate;
            if (mesh.position.x > 6.5 || mesh.position.x < -6.5) {
                direction *= -1;
            }
            let panValue = 2 * (mesh.position.x / 6.5);
            if (invertPanning) panValue *= -1;
            panner.pan.value = Math.max(-1, Math.min(1, panValue));

            gainNode.gain.value = volume * (0.2 + 0.8 * Math.abs(mesh.position.x / 6.5));

            renderer.render(scene, camera);
        }

        function stopAudio() {
            if (oscillator) {
                oscillator.stop();
                oscillator.disconnect();
                oscillator = null;
            }
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            document.getElementById('startButton').style.display = "block";
            document.getElementById('endButton').style.display = 'none';
            isAudioStarted = false;

            // Fade in start button
            document.getElementById('startButton').classList.remove('hidden');
        }

        function updateSoundType() {
            if (isAudioStarted && audioContext && oscillator) {
                const soundType = document.querySelector('input[name="soundType"]:checked').value;
                oscillator.type = soundType;
            }
        }

        init();
    </script>
</body>
</html>
